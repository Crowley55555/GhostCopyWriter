# =============================================================================
# GHOSTWRITER - Docker Compose для Flask микросервиса
# =============================================================================
# Развертывание на ЗАРУБЕЖНОМ сервере (OpenAI API)
# =============================================================================
# Запуск: docker-compose -f docker-compose.flask.yml up -d
# Логи: docker-compose -f docker-compose.flask.yml logs -f
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Flask AI Generator (OpenAI GPT + DALL-E)
  # ===========================================================================
  flask:
    build: ./flask_generator
    container_name: ghostwriter-flask-prod
    expose:
      - "5000"
    environment:
      - FLASK_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GENERATOR_ENCRYPTION_KEY=${GENERATOR_ENCRYPTION_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - DALLE_MODEL=${DALLE_MODEL:-dall-e-3}
    volumes:
      - flask_logs:/app/logs
    networks:
      - flask-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ===========================================================================
  # Nginx для Flask (HTTPS termination)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: ghostwriter-flask-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./flask_generator/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      flask:
        condition: service_healthy
    networks:
      - flask-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Volumes
# =============================================================================
volumes:
  flask_logs:
    driver: local
  nginx_logs:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  flask-network:
    driver: bridge
