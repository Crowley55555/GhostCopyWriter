<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghostwriter AI - Генератор SMM контента</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Хедер -->
    <header class="header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="header-brand">
                        <i class="bi bi-robot me-2"></i>
                        <span class="brand-text">Ghostwriter AI</span>
                        <span class="brand-subtitle">Генератор SMM контента</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="header-controls">
                        <div class="datetime-display mb-2">
                            <i class="bi bi-calendar3 me-1"></i>
                            <span id="currentDate"></span>
                        </div>
                        <div class="datetime-display">
                            <i class="bi bi-clock me-1"></i>
                            <span id="currentTime"></span>
                        </div>
                        <button id="themeToggle" class="btn btn-theme-toggle mt-2" onclick="toggleTheme()">
                            <i class="bi bi-sun-fill" id="themeIcon"></i>
                            <span id="themeText">Темная тема</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-magic me-2"></i>Генератор постов
            </a>
            <span class="navbar-text opacity-75">
                Создавайте контент с помощью ИИ
            </span>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container-fluid py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                
                <!-- Заголовок -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-gradient mb-3">
                        <i class="bi bi-magic me-3"></i>Генератор постов
                    </h1>
                    <p class="lead text-muted">Создавайте привлекательный контент для социальных сетей с помощью ИИ</p>
                </div>

                <!-- Форма генерации -->
                <div class="card shadow-lg border-0 mb-5">
                    <div class="card-header bg-primary bg-gradient text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear me-2"></i>Настройки генерации
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" class="needs-validation" novalidate id="generateForm">
                            {% csrf_token %}
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <label for="{{ form.platform.id_for_label }}" class="form-label fw-semibold">
                                        <i class="bi bi-globe me-2"></i>Платформа
                                    </label>
                                    {{ form.platform }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.template_type.id_for_label }}" class="form-label fw-semibold">
                                        <i class="bi bi-file-text me-2"></i>Тип контента
                                    </label>
                                    {{ form.template_type }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.tone.id_for_label }}" class="form-label fw-semibold">
                                        <i class="bi bi-chat-quote me-2"></i>Тональность
                                    </label>
                                    {{ form.tone }}
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.topic.id_for_label }}" class="form-label fw-semibold">
                                        <i class="bi bi-lightbulb me-2"></i>Тема поста
                                    </label>
                                    {{ form.topic }}
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Опишите тему, о которой хотите написать пост
                                    </div>
                                </div>
                                <div class="col-12 text-center">
                                    <button type="button" id="generateBtn" class="btn btn-primary btn-lg px-5" onclick="handleGenerateClick(event)">
                                        <i class="bi bi-wand-magic-sparkles me-2" id="generateIcon"></i>
                                        <span id="generateText">Сгенерировать контент</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Результат -->
                <div id="resultsContainer" style="display: none;">
                    <div class="row g-4">
                        <!-- Текстовый результат -->
                        <div class="col-lg-6">
                            <div class="card shadow-lg border-0 h-100">
                                <div class="card-header bg-success bg-gradient text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-file-text me-2"></i>Сгенерированный пост
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <div id="result" class="auto-resize-textarea" contenteditable="false"></div>
                                    <div class="mt-3 d-flex gap-2 flex-wrap">
                                        <button onclick="copyText()" class="btn btn-outline-primary">
                                            <i class="bi bi-clipboard me-2"></i>Скопировать
                                        </button>
                                        <button onclick="handleRegenerateTextClick(event)" class="btn btn-outline-warning">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Перегенерировать текст
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Изображение -->
                        <div class="col-lg-6">
                            <div class="card shadow-lg border-0 h-100">
                                <div class="card-header bg-info bg-gradient text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-image me-2"></i>Сгенерированная иллюстрация
                                    </h5>
                                </div>
                                <div class="card-body p-4 text-center">
                                    <div id="imageContainer">
                                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-3">Изображение будет сгенерировано автоматически</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Статистика -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card shadow-lg border-0">
                                <div class="card-header bg-dark bg-gradient text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-graph-up me-2"></i>Статистика генерации
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-calendar-check text-primary fs-1"></i>
                                                <h4 class="mt-2" id="charCount">0</h4>
                                                <p class="text-muted">Символов в тексте</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-clock text-success fs-1"></i>
                                                <h4 class="mt-2" id="wordCount">0</h4>
                                                <p class="text-muted">Слов в тексте</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-image text-info fs-1"></i>
                                                <h4 class="mt-2" id="imageCount">0</h4>
                                                <p class="text-muted">Изображений</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-lightning text-warning fs-1"></i>
                                                <h4 class="mt-2">AI</h4>
                                                <p class="text-muted">Powered by GigaChat</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Результат (старый способ для совместимости) -->
                {% if result %}
                    <div class="row g-4">
                        <!-- Текстовый результат -->
                        <div class="col-lg-6">
                            <div class="card shadow-lg border-0 h-100">
                                <div class="card-header bg-success bg-gradient text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-file-text me-2"></i>Сгенерированный пост
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    {% if limit_reached %}
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle me-2"></i>{{ result }}
                                        </div>
                                    {% else %}
                                        <div id="result" class="auto-resize-textarea" contenteditable="false">{{ result }}</div>
                                        <div class="mt-3 d-flex gap-2">
                                            <button onclick="copyText()" class="btn btn-outline-primary">
                                                <i class="bi bi-clipboard me-2"></i>Скопировать
                                            </button>
                                            <button onclick="handleRegenerateClick(event)" class="btn btn-outline-secondary">
                                                <i class="bi bi-arrow-clockwise me-2"></i>Сгенерировать ещё
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Изображение -->
                        <div class="col-lg-6">
                            {% if image_url %}
                                <div class="card shadow-lg border-0 h-100">
                                    <div class="card-header bg-info bg-gradient text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-image me-2"></i>Сгенерированная иллюстрация
                                        </h5>
                                    </div>
                                    <div class="card-body p-4 text-center">
                                        <div class="debug-info mb-3">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>Debug: {{ image_url|truncatechars:50 }}
                                            </small>
                                        </div>
                                        
                                        <div class="image-container position-relative">
                                            <img src="{{ image_url }}" alt="AI generated image" 
                                                 class="img-fluid rounded shadow-sm generated-image" 
                                                 onclick="openModal(this.src)" 
                                                 onerror="handleImageError(this)" 
                                                 onload="handleImageLoad(this)" />
                                            
                                            <!-- Overlay для увеличения -->
                                            <div class="image-overlay" onclick="openModal('{{ image_url }}')">
                                                <i class="bi bi-zoom-in text-white fs-1"></i>
                                            </div>
                                        </div>
                                        
                                        <div id="imageError" class="alert alert-danger mt-3" style="display: none;"></div>
                                        
                                        <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                                            <button onclick="openModal('{{ image_url }}')" class="btn btn-outline-info">
                                                <i class="bi bi-zoom-in me-2"></i>Увеличить
                                            </button>
                                            <button onclick="downloadImage('{{ image_url }}')" class="btn btn-outline-success">
                                                <i class="bi bi-download me-2"></i>Сохранить
                                            </button>
                                            <button onclick="handleRegenerateImageClick(event)" class="btn btn-outline-warning">
                                                <i class="bi bi-image me-2"></i>Перегенерировать изображение
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="card shadow-lg border-0 h-100">
                                    <div class="card-header bg-warning bg-gradient text-dark">
                                        <h5 class="mb-0">
                                            <i class="bi bi-exclamation-triangle me-2"></i>Изображение не сгенерировано
                                        </h5>
                                    </div>
                                    <div class="card-body p-4 text-center">
                                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-3">Попробуйте сгенерировать контент ещё раз</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                <!-- Статистика -->
                {% if result %}
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card shadow-lg border-0">
                                <div class="card-header bg-dark bg-gradient text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-graph-up me-2"></i>Статистика генерации
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-calendar-check text-primary fs-1"></i>
                                                <h4 class="mt-2">{{ result|length }}</h4>
                                                <p class="text-muted">Символов в тексте</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-clock text-success fs-1"></i>
                                                <h4 class="mt-2">{{ result|wordcount }}</h4>
                                                <p class="text-muted">Слов в тексте</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-image text-info fs-1"></i>
                                                <h4 class="mt-2">{% if image_url %}1{% else %}0{% endif %}</h4>
                                                <p class="text-muted">Изображений</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <i class="bi bi-lightning text-warning fs-1"></i>
                                                <h4 class="mt-2">AI</h4>
                                                <p class="text-muted">Powered by GigaChat</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Модальное окно для увеличенного изображения -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img class="img-fluid rounded shadow-lg" id="modalImage" alt="Full size image">
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button onclick="downloadImage(document.getElementById('modalImage').src)" class="btn btn-light">
                        <i class="bi bi-download me-2"></i>Сохранить изображение
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">
                <i class="bi bi-heart-fill text-danger me-1"></i>
                Создано с помощью GigaChat AI
            </p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Простая функция переключения темы
        function toggleTheme() {
            console.log('toggleTheme вызвана');
            
            const html = document.documentElement;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            const currentTheme = html.getAttribute('data-theme');
            console.log('Текущая тема:', currentTheme);
            
            if (currentTheme === 'dark') {
                html.setAttribute('data-theme', 'light');
                body.setAttribute('data-theme', 'light');
                if (themeIcon) themeIcon.className = 'bi bi-sun-fill';
                if (themeText) themeText.textContent = 'Темная тема';
                localStorage.setItem('theme', 'light');
                console.log('Переключено на светлую тему');
            } else {
                html.setAttribute('data-theme', 'dark');
                body.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.className = 'bi bi-moon-fill';
                if (themeText) themeText.textContent = 'Светлая тема';
                localStorage.setItem('theme', 'dark');
                console.log('Переключено на темную тему');
            }
            
            // Обновляем дату и время после переключения темы
            updateDateTime();
            
            // Принудительно показываем элементы datetime-display
            setTimeout(() => {
                const datetimeDisplays = document.querySelectorAll('.datetime-display');
                datetimeDisplays.forEach(display => {
                    display.style.display = 'flex';
                    display.style.visibility = 'visible';
                    display.style.opacity = '1';
                    
                    // Принудительно обновляем стили для видимости
                    const currentTheme = html.getAttribute('data-theme');
                    if (currentTheme === 'light') {
                        display.style.color = '#ffffff';
                        display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = '#ffffff';
                            icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        });
                    } else {
                        display.style.color = 'var(--text-primary)';
                        display.style.textShadow = 'none';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = 'var(--text-primary)';
                            icon.style.textShadow = 'none';
                        });
                    }
                });
            }, 100);
        }

        // Загрузка сохраненной темы
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            html.setAttribute('data-theme', savedTheme);
            body.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'dark') {
                if (themeIcon) themeIcon.className = 'bi bi-moon-fill';
                if (themeText) themeText.textContent = 'Светлая тема';
            } else {
                if (themeIcon) themeIcon.className = 'bi bi-sun-fill';
                if (themeText) themeText.textContent = 'Темная тема';
            }
            
            // Обновляем дату и время после загрузки темы
            updateDateTime();
            
            // Принудительно показываем элементы datetime-display
            setTimeout(() => {
                const datetimeDisplays = document.querySelectorAll('.datetime-display');
                datetimeDisplays.forEach(display => {
                    display.style.display = 'flex';
                    display.style.visibility = 'visible';
                    display.style.opacity = '1';
                    
                    // Принудительно обновляем стили для видимости
                    if (savedTheme === 'light') {
                        display.style.color = '#ffffff';
                        display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = '#ffffff';
                            icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        });
                    } else {
                        display.style.color = 'var(--text-primary)';
                        display.style.textShadow = 'none';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = 'var(--text-primary)';
                            icon.style.textShadow = 'none';
                        });
                    }
                });
            }, 100);
        }

        // Функция для управления состоянием кнопки генерации
        function setGenerateButtonLoading(isLoading) {
            const generateBtn = document.getElementById('generateBtn');
            const generateIcon = document.getElementById('generateIcon');
            const generateText = document.getElementById('generateText');
            
            if (isLoading) {
                // Отключаем кнопку и показываем состояние загрузки
                generateBtn.classList.add('btn-loading');
                generateIcon.className = 'bi bi-arrow-clockwise me-2 icon-loading';
                generateText.textContent = 'Генерация...';
                generateBtn.disabled = true;
            } else {
                // Включаем кнопку и возвращаем исходное состояние
                generateBtn.classList.remove('btn-loading');
                generateIcon.className = 'bi bi-wand-magic-sparkles me-2';
                generateText.textContent = 'Сгенерировать контент';
                generateBtn.disabled = false;
            }
        }

        // Обработчик клика по кнопке генерации
        function handleGenerateClick(event) {
            // Проверяем, что форма валидна
            const form = document.getElementById('generateForm');
            if (form && form.checkValidity()) {
                // Отключаем кнопку
                setGenerateButtonLoading(true);
                
                // Показываем уведомление о начале генерации
                showToast('Начинаем генерацию контента...', 'info');
                
                // Скрываем старые результаты
                const resultsContainer = document.getElementById('resultsContainer');
                if (resultsContainer) {
                    resultsContainer.style.display = 'none';
                }
                
                // Отправляем AJAX запрос
                sendGenerateRequest();
            } else {
                // Если форма не валидна, показываем ошибку
                showToast('Пожалуйста, заполните все обязательные поля', 'warning');
                event.preventDefault();
            }
        }

        // Функция для получения CSRF токена
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                return token.value;
            }
            // Если токен не найден в форме, получаем из cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Отправка AJAX запроса для генерации
        function sendGenerateRequest() {
            const form = document.getElementById('generateForm');
            const formData = new FormData(form);
            
            // Получаем CSRF токен
            const csrfToken = getCSRFToken();
            
            // Показываем прогресс
            showProgress('Начинаем генерацию текста...');
            
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Показываем результаты
                    displayResults(data);
                    showToast('Контент успешно сгенерирован!', 'success');
                } else {
                    // Показываем ошибку
                    showToast(data.error || 'Ошибка генерации контента', 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при генерации контента', 'danger');
            })
            .finally(() => {
                // Включаем кнопку обратно
                setGenerateButtonLoading(false);
            });
        }

        // Показ прогресса генерации
        function showProgress(message) {
            showToast(message, 'info');
        }

        // Отображение результатов
        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultText = document.getElementById('result');
            const imageContainer = document.getElementById('imageContainer');
            const charCount = document.getElementById('charCount');
            const wordCount = document.getElementById('wordCount');
            const imageCount = document.getElementById('imageCount');
            
            if (resultsContainer && resultText) {
                // Показываем контейнер результатов
                resultsContainer.style.display = 'block';
                
                // Обновляем текст
                resultText.textContent = data.result || '';
                
                // Обновляем статистику
                if (charCount) charCount.textContent = (data.result || '').length;
                if (wordCount) wordCount.textContent = (data.result || '').split(' ').length;
                if (imageCount) imageCount.textContent = data.image_url ? '1' : '0';
                
                // Обновляем изображение
                if (data.image_url && imageContainer) {
                    // Показываем состояние загрузки
                    imageContainer.innerHTML = `
                        <div class="image-loading">
                            <i class="bi bi-image"></i>
                            <p>Загружаем изображение...</p>
                        </div>
                    `;
                    
                    // Создаем изображение для предзагрузки
                    const img = new Image();
                    img.onload = function() {
                        imageContainer.innerHTML = `
                            <div class="image-container position-relative">
                                <img src="${data.image_url}" alt="AI generated image" 
                                     class="generated-image" 
                                     onclick="openModal(this.src)" 
                                     onerror="handleImageError(this)" 
                                     onload="handleImageLoad(this)" />
                                
                                <!-- Overlay для увеличения -->
                                <div class="image-overlay" onclick="openModal('${data.image_url}')">
                                    <i class="bi bi-zoom-in text-white fs-1"></i>
                                </div>
                            </div>
                            
                            <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                                <button onclick="openModal('${data.image_url}')" class="btn btn-outline-info">
                                    <i class="bi bi-zoom-in me-2"></i>Увеличить
                                </button>
                                <button onclick="downloadImage('${data.image_url}')" class="btn btn-outline-success">
                                    <i class="bi bi-download me-2"></i>Сохранить
                                </button>
                                <button onclick="handleRegenerateImageClick(event)" class="btn btn-outline-warning">
                                    <i class="bi bi-image me-2"></i>Перегенерировать изображение
                                </button>
                            </div>
                        `;
                    };
                    img.onerror = function() {
                        imageContainer.innerHTML = `
                            <div class="image-error">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>Ошибка загрузки изображения</p>
                            </div>
                        `;
                    };
                    img.src = data.image_url;
                } else if (imageContainer) {
                    // Если изображение не сгенерировано
                    imageContainer.innerHTML = `
                        <div class="image-error">
                            <i class="bi bi-image"></i>
                            <p>Изображение не было сгенерировано</p>
                        </div>
                    `;
                }
                
                // Подстраиваем высоту текстового поля
                autoResizeTextarea();
                
                // Плавная анимация появления
                resultsContainer.style.opacity = '0';
                resultsContainer.style.transform = 'translateY(20px)';
                resultsContainer.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    resultsContainer.style.opacity = '1';
                    resultsContainer.style.transform = 'translateY(0)';
                }, 100);
            }
        }

        // Обработчик клика по кнопке "Сгенерировать ещё"
        function handleRegenerateClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2 icon-loading"></i>Генерация...';
            
            // Показываем уведомление
            showToast('Генерируем новый контент...', 'info');
            
            // Отправляем AJAX запрос
            sendGenerateRequest();
        }

        // Обработчик клика по кнопке "Перегенерировать текст"
        function handleRegenerateTextClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2 icon-loading"></i>Генерация текста...';
            
            // Показываем уведомление
            showToast('Перегенерируем текст...', 'info');
            
            // Получаем данные формы
            const formData = new FormData();
            formData.append('platform', document.getElementById('id_platform').value);
            formData.append('template_type', document.getElementById('id_template_type').value);
            formData.append('tone', document.getElementById('id_tone').value);
            formData.append('topic', document.getElementById('id_topic').value);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Отправляем AJAX запрос для перегенерации текста
            fetch('/regenerate-text/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем текст
                    const resultElement = document.getElementById('result');
                    if (resultElement) {
                        resultElement.textContent = data.result;
                        autoResizeTextarea();
                    }
                    
                    // Обновляем статистику
                    const charCount = document.getElementById('charCount');
                    const wordCount = document.getElementById('wordCount');
                    if (charCount) charCount.textContent = data.result.length;
                    if (wordCount) wordCount.textContent = data.result.split(' ').length;
                    
                    showToast('Текст успешно перегенерирован!', 'success');
                } else {
                    showToast('Ошибка при перегенерации текста: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка при перегенерации текста:', error);
                showToast('Ошибка при перегенерации текста', 'danger');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                regenerateBtn.classList.remove('btn-loading');
                regenerateBtn.disabled = false;
                regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Перегенерировать текст';
            });
        }

        // Обработчик клика по кнопке "Перегенерировать изображение"
        function handleRegenerateImageClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-image me-2 icon-loading"></i>Генерация изображения...';
            
            // Показываем уведомление
            showToast('Перегенерируем изображение...', 'info');
            
            // Получаем тему из формы
            const topic = document.getElementById('id_topic').value;
            
            // Получаем данные формы
            const formData = new FormData();
            formData.append('topic', topic);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Отправляем AJAX запрос для перегенерации изображения
            fetch('/regenerate-image/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем изображение
                    const imageContainer = document.getElementById('imageContainer');
                    if (imageContainer && data.image_url) {
                        // Показываем состояние загрузки
                        imageContainer.innerHTML = `
                            <div class="image-loading">
                                <i class="bi bi-image"></i>
                                <p>Загружаем новое изображение...</p>
                            </div>
                        `;
                        
                        // Создаем изображение для предзагрузки
                        const img = new Image();
                        img.onload = function() {
                            imageContainer.innerHTML = `
                                <div class="image-container position-relative">
                                    <img src="${data.image_url}" alt="AI generated image" 
                                         class="generated-image" 
                                         onclick="openModal(this.src)" 
                                         onerror="handleImageError(this)" 
                                         onload="handleImageLoad(this)" />
                                    
                                    <!-- Overlay для увеличения -->
                                    <div class="image-overlay" onclick="openModal('${data.image_url}')">
                                        <i class="bi bi-zoom-in text-white fs-1"></i>
                                    </div>
                                </div>
                                
                                <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                                    <button onclick="openModal('${data.image_url}')" class="btn btn-outline-info">
                                        <i class="bi bi-zoom-in me-2"></i>Увеличить
                                    </button>
                                    <button onclick="downloadImage('${data.image_url}')" class="btn btn-outline-success">
                                        <i class="bi bi-download me-2"></i>Сохранить
                                    </button>
                                    <button onclick="handleRegenerateImageClick(event)" class="btn btn-outline-warning">
                                        <i class="bi bi-image me-2"></i>Перегенерировать изображение
                                    </button>
                                </div>
                            `;
                        };
                        img.onerror = function() {
                            imageContainer.innerHTML = `
                                <div class="image-error">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <p>Ошибка загрузки изображения</p>
                                </div>
                            `;
                        };
                        img.src = data.image_url;
                    }
                    
                    // Обновляем статистику
                    const imageCount = document.getElementById('imageCount');
                    if (imageCount) imageCount.textContent = '1';
                    
                    showToast('Изображение успешно перегенерировано!', 'success');
                } else {
                    showToast('Ошибка при перегенерации изображения: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка при перегенерации изображения:', error);
                showToast('Ошибка при перегенерации изображения', 'danger');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                regenerateBtn.classList.remove('btn-loading');
                regenerateBtn.disabled = false;
                regenerateBtn.innerHTML = '<i class="bi bi-image me-2"></i>Перегенерировать изображение';
            });
        }

        // Автоматическое подстраивание высоты текстового поля
        function autoResizeTextarea() {
            const textarea = document.getElementById('result');
            if (textarea) {
                // Создаем временный элемент для измерения высоты
                const temp = document.createElement('div');
                temp.style.cssText = `
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                    width: ${textarea.offsetWidth}px;
                    padding: ${getComputedStyle(textarea).padding};
                    font: ${getComputedStyle(textarea).font};
                    line-height: ${getComputedStyle(textarea).lineHeight};
                    word-wrap: break-word;
                    white-space: pre-wrap;
                    overflow: hidden;
                `;
                temp.textContent = textarea.textContent || textarea.innerText;
                
                document.body.appendChild(temp);
                const height = temp.scrollHeight;
                document.body.removeChild(temp);
                
                // Устанавливаем высоту с учетом минимальной и максимальной
                const minHeight = 150;
                const maxHeight = 600;
                const newHeight = Math.max(minHeight, Math.min(maxHeight, height));
                
                textarea.style.height = newHeight + 'px';
            }
        }

        // Инициализация при загрузке страницы - используем window.onload
        window.onload = function() {
            console.log('Страница загружена');
            
            // Загружаем тему
            loadTheme();
            
            // Находим кнопку
            const themeToggle = document.getElementById('themeToggle');
            console.log('Кнопка найдена:', themeToggle);
            
            if (!themeToggle) {
                console.error('Кнопка не найдена!');
            }
            
            // Принудительно обновляем дату и время сразу
            console.log('Запускаем обновление даты и времени...');
            updateDateTime();
            
            // Запускаем обновление даты и времени
            startDateTimeUpdate();
            
            // Подстраиваем высоту текстового поля
            autoResizeTextarea();
            
            console.log('Инициализация завершена');
        };

        // Копирование текста
        function copyText() {
            const text = document.getElementById("result");
            navigator.clipboard.writeText(text.textContent || text.innerText).then(() => {
                showToast('Текст скопирован в буфер обмена!', 'success');
            });
        }

        // Открытие модального окна
        function openModal(imageSrc) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modalImage').src = imageSrc;
            modal.show();
        }

        // Скачивание изображения
        function downloadImage(imageSrc) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = 'ghostwriter_generated_image.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Изображение сохранено!', 'success');
        }

        // Обработка ошибок изображения
        function handleImageError(image) {
            console.log("Ошибка загрузки изображения:", image.src);
            
            // Находим контейнер изображения
            const imageContainer = image.closest('.image-container');
            if (imageContainer) {
                const parentContainer = imageContainer.parentElement;
                parentContainer.innerHTML = `
                    <div class="image-error">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Ошибка загрузки изображения</p>
                    </div>
                `;
            }
        }

        function handleImageLoad(image) {
            console.log("Изображение успешно загружено:", image.naturalWidth + "x" + image.naturalHeight);
            
            // Добавляем анимацию появления
            image.style.opacity = '0';
            image.style.transform = 'scale(0.9)';
            image.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                image.style.opacity = '1';
                image.style.transform = 'scale(1)';
            }, 100);
        }

        // Показ уведомлений
        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }

        // Функция для отображения даты и времени
        function updateDateTime() {
            const now = new Date();
            
            // Форматирование даты на русском языке
            const dateOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            
            // Форматирование времени
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            
            const currentDate = now.toLocaleDateString('ru-RU', dateOptions);
            const currentTime = now.toLocaleTimeString('ru-RU', timeOptions);
            
            // Обновляем элементы на странице
            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');
            
            console.log('updateDateTime вызвана');
            console.log('Текущая дата:', currentDate);
            console.log('Текущее время:', currentTime);
            console.log('Элемент даты найден:', dateElement);
            console.log('Элемент времени найден:', timeElement);
            console.log('Текущая тема:', document.documentElement.getAttribute('data-theme'));
            
            if (dateElement) {
                dateElement.textContent = currentDate;
                dateElement.style.display = 'inline';
                dateElement.style.visibility = 'visible';
                dateElement.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    dateElement.style.color = '#ffffff';
                    dateElement.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                } else {
                    dateElement.style.color = 'var(--text-primary)';
                    dateElement.style.textShadow = 'none';
                }
                console.log('Дата обновлена');
            } else {
                console.error('Элемент даты не найден!');
            }
            
            if (timeElement) {
                timeElement.textContent = currentTime;
                timeElement.style.display = 'inline';
                timeElement.style.visibility = 'visible';
                timeElement.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    timeElement.style.color = '#ffffff';
                    timeElement.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                } else {
                    timeElement.style.color = 'var(--text-primary)';
                    timeElement.style.textShadow = 'none';
                }
                console.log('Время обновлено');
            } else {
                console.error('Элемент времени не найден!');
            }
            
            // Принудительно показываем контейнеры datetime-display
            const datetimeDisplays = document.querySelectorAll('.datetime-display');
            const currentTheme = document.documentElement.getAttribute('data-theme');
            
            datetimeDisplays.forEach(display => {
                display.style.display = 'flex';
                display.style.visibility = 'visible';
                display.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                if (currentTheme === 'light') {
                    display.style.color = '#ffffff';
                    display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    
                    // Обновляем стили для иконок
                    const icons = display.querySelectorAll('i');
                    icons.forEach(icon => {
                        icon.style.color = '#ffffff';
                        icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    });
                } else {
                    display.style.color = 'var(--text-primary)';
                    display.style.textShadow = 'none';
                    
                    // Обновляем стили для иконок
                    const icons = display.querySelectorAll('i');
                    icons.forEach(icon => {
                        icon.style.color = 'var(--text-primary)';
                        icon.style.textShadow = 'none';
                    });
                }
            });
        }
        
        // Обновляем время каждую секунду
        function startDateTimeUpdate() {
            console.log('startDateTimeUpdate вызвана');
            updateDateTime(); // Первоначальное обновление
            setInterval(updateDateTime, 1000); // Обновление каждую секунду
            console.log('Интервал обновления установлен');
        }
        
        // Альтернативная инициализация при готовности DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен');
            updateDateTime();
        });
        
        // Валидация формы
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>
</body>
</html>

