<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghostwriter AI - Генератор SMM контента</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Хедер -->
    <header class="header">
        <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between py-2">
                    <div class="header-brand">
                        <i class="bi bi-robot me-2"></i>
                        <span class="brand-text">Ghostwriter AI</span>
                        <span class="brand-subtitle">Генератор SMM контента</span>
                    </div>
                <div class="header-controls d-flex align-items-center gap-3">
                    <div class="datetime-display mb-0">
                            <i class="bi bi-calendar3 me-1"></i>
                            <span id="currentDate"></span>
                        </div>
                    <div class="datetime-display mb-0">
                            <i class="bi bi-clock me-1"></i>
                            <span id="currentTime"></span>
                        </div>
                    <div class="d-flex align-items-center gap-2">
                        <button id="themeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()">
                            <i class="bi bi-sun-fill" id="themeIcon"></i>
                            <span id="themeText">Киберпанк</span>
                        </button>
                        {% block header_buttons %}
                          {% if user.is_authenticated %}
                            <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm ms-2"><i class="bi bi-box-arrow-right me-1"></i>Выйти</a>
                          {% endif %}
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>
        {% block nav_menu %}{% endblock %}
    </header>

    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-magic me-2"></i>Генератор постов
            </a>
            <span class="navbar-text opacity-75">
                Создавайте контент с помощью ИИ
            </span>
        </div>
    </nav>

    <!-- Основной контент -->
    {% block content %}
    <!-- Контент страницы -->
    {% endblock %}

    <!-- Модальное окно для увеличенного изображения -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img class="img-fluid rounded shadow-lg" id="modalImage" alt="Full size image">
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button onclick="downloadImage(document.getElementById('modalImage').src)" class="btn btn-light">
                        <i class="bi bi-download me-2"></i>Сохранить изображение
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <p class="mb-0">
                        <i class="bi bi-heart-fill text-danger me-1"></i>
                        Создано с помощью AI
                    </p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-2 text-warning" style="font-size: 0.9rem; font-weight: 500;">
                        ⚠️ Сгенерированный контент = ваша ответственность
                    </p>
                    <a href="{% url 'disclaimer_page' %}" class="text-light text-decoration-none" style="font-size: 0.85rem;">
                        <i class="bi bi-shield-exclamation me-1"></i>Отказ от ответственности
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Модальное окно с отказом от ответственности при первом входе -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="disclaimerModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>ВАЖНО: Отказ от ответственности
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <strong>⚠️ Сгенерированный контент = ваша ответственность</strong><br>
                        Пользователь самостоятельно несет все риски, связанные с использованием сгенерированного контента.
                    </div>
                    
                    <h6>1. Отсутствие гарантий качества</h6>
                    <p class="small">1.1. Сервис GhostCopywriter генерирует контент на основе нейронных сетей без гарантии точности, актуальности или соответствия фактам.</p>
                    <p class="small">1.2. Исполнитель не проверяет и не редактирует автоматически созданный контент.</p>
                    <p class="small">1.3. Возможны ошибки, неточности, неуместные формулировки, нарушения стиля или авторских прав.</p>
                    
                    <h6 class="mt-3">2. Ответственность за публикацию</h6>
                    <p class="small"><strong>2.1. Пользователь самостоятельно несет 100% ответственность за:</strong></p>
                    <ul class="small">
                        <li>правдивость и достоверность опубликованного контента;</li>
                        <li>соблюдение законодательства (рекламные правила, авторские права, товарные знаки);</li>
                        <li>отсутствие запрещенной информации (экстремизм, насилие, дискриминация);</li>
                        <li>претензии со стороны платформ (блокировка аккаунтов, удаление постов).</li>
                    </ul>
                    <p class="small"><strong>2.2. Исполнитель не несет ответственности за любые последствия публикации, включая:</strong></p>
                    <ul class="small">
                        <li>финансовые убытки от штрафов или блокировок;</li>
                        <li>репутационные потери;</li>
                        <li>судебные иски от третьих лиц.</li>
                    </ul>
                    
                    <h6 class="mt-3">3. Платформы социальных сетей</h6>
                    <p class="small">3.1. Пользователь самостоятельно проверяет сгенерированный контент на соответствие Правилам Instagram, VK, Facebook, TikTok, YouTube и других платформ, Рекламному законодательству РФ (№ 38-ФЗ), Закону о рекламе и маркировке (единый реестр РКН).</p>
                    <p class="small">3.2. Исполнитель не дает рекомендаций по размещению рекламы и не несет ответственности за нарушения.</p>
                    
                    <h6 class="mt-3">4. Авторские права и плагиат</h6>
                    <p class="small">4.1. Сгенерированный контент может содержать элементы чужих текстов из обучающих данных ИИ.</p>
                    <p class="small">4.2. Пользователь обязан самостоятельно проверить уникальность через сервисы (Text.ru, Advego, Copyleaks).</p>
                    <p class="small">4.3. Исполнитель не гарантирует 100% оригинальность и не отвечает за претензии правообладателей.</p>
                    
                    <h6 class="mt-3">5. Ограничение ответственности Исполнителя</h6>
                    <p class="small">5.1. Максимальная ответственность Исполнителя = стоимость последней оплаченной подписки.</p>
                    <p class="small">5.2. Исполнитель не отвечает за косвенные убытки, упущенную выгоду, моральный вред.</p>
                    <p class="small">5.3. Пользователь подтверждает, что понимает риски ИИ-генерации и принимает их добровольно.</p>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <h6 class="alert-heading">6. Рекомендации Пользователю (не обязательны)</h6>
                        <ul class="mb-0 small">
                            <li>Проверять факты и цифры вручную;</li>
                            <li>Использовать уникализаторы текста;</li>
                            <li>Соблюдать лимиты платформ по автопостингу;</li>
                            <li>Маркировать рекламу (#реклама, #продажа);</li>
                            <li>Тестировать контент на небольшой аудитории.</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{% url 'disclaimer_page' %}" class="btn btn-outline-info" target="_blank">
                        <i class="bi bi-file-text me-1"></i>Полный текст
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check-circle me-1"></i>Понятно
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Показываем модальное окно при первом входе через токен (если не было показано ранее)
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, есть ли токен в сессии (пользователь авторизован)
            const hasToken = {% if request.session.access_token %}true{% else %}false{% endif %};
            
            if (hasToken) {
                const disclaimerShown = sessionStorage.getItem('disclaimerShown');
                if (!disclaimerShown) {
                    const disclaimerModalElement = document.getElementById('disclaimerModal');
                    if (disclaimerModalElement) {
                        const disclaimerModal = new bootstrap.Modal(disclaimerModalElement);
                        disclaimerModal.show();
                        sessionStorage.setItem('disclaimerShown', 'true');
                    }
                }
            }
        });
    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Простая функция переключения темы
        function toggleTheme() {
            const html = document.documentElement;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            const currentTheme = html.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                html.setAttribute('data-theme', 'light');
                body.setAttribute('data-theme', 'light');
                if (themeIcon) themeIcon.className = 'bi bi-sun-fill';
                if (themeText) themeText.textContent = 'Киберпанк';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                body.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.className = 'bi bi-moon-fill';
                if (themeText) themeText.textContent = 'Светлая тема';
                localStorage.setItem('theme', 'dark');
            }
            
            // Обновляем дату и время после переключения темы
            updateDateTime();
            
            // Принудительно показываем элементы datetime-display
            setTimeout(() => {
                const datetimeDisplays = document.querySelectorAll('.datetime-display');
                datetimeDisplays.forEach(display => {
                    display.style.display = 'flex';
                    display.style.visibility = 'visible';
                    display.style.opacity = '1';
                    
                    // Принудительно обновляем стили для видимости
                    const currentTheme = html.getAttribute('data-theme');
                    if (currentTheme === 'light') {
                        display.style.color = '#ffffff';
                        display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = '#ffffff';
                            icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        });
                    } else {
                        display.style.color = 'var(--text-primary)';
                        display.style.textShadow = 'none';
                        
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = 'var(--text-primary)';
                            icon.style.textShadow = 'none';
                        });
                    }
                });
            }, 100);
        }

        // Загрузка сохраненной темы
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            html.setAttribute('data-theme', savedTheme);
            body.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                if (themeIcon) themeIcon.className = 'bi bi-moon-fill';
                if (themeText) themeText.textContent = 'Светлая тема';
            } else {
                if (themeIcon) themeIcon.className = 'bi bi-sun-fill';
                if (themeText) themeText.textContent = 'Киберпанк';
            }
            // Обновляем дату и время после загрузки темы
            updateDateTime();
            // Принудительно показываем элементы datetime-display
            setTimeout(() => {
                const datetimeDisplays = document.querySelectorAll('.datetime-display');
                datetimeDisplays.forEach(display => {
                    display.style.display = 'flex';
                    display.style.visibility = 'visible';
                    display.style.opacity = '1';
                    // Принудительно обновляем стили для видимости
                    if (savedTheme === 'light') {
                        display.style.color = '#ffffff';
                        display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = '#ffffff';
                            icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                        });
                    } else {
                        display.style.color = 'var(--text-primary)';
                        display.style.textShadow = 'none';
                        // Обновляем стили для иконок
                        const icons = display.querySelectorAll('i');
                        icons.forEach(icon => {
                            icon.style.color = 'var(--text-primary)';
                            icon.style.textShadow = 'none';
                        });
                    }
                });
            }, 100);
        }
        window.addEventListener('DOMContentLoaded', function() {
            loadTheme();
        });

        // Функция для управления состоянием кнопки генерации
        function setGenerateButtonLoading(isLoading) {
            const generateBtn = document.getElementById('generateBtn');
            const generateIcon = document.getElementById('generateIcon');
            const generateText = document.getElementById('generateText');
            
            if (isLoading) {
                // Отключаем кнопку и показываем состояние загрузки
                generateBtn.classList.add('btn-loading');
                generateIcon.className = 'bi bi-arrow-clockwise me-2 icon-loading';
                generateText.textContent = 'Генерация...';
                generateBtn.disabled = true;
            } else {
                // Включаем кнопку и возвращаем исходное состояние
                generateBtn.classList.remove('btn-loading');
                generateIcon.className = 'bi bi-wand-magic-sparkles me-2';
                generateText.textContent = 'Сгенерировать контент';
                generateBtn.disabled = false;
            }
        }

        // Обработчик клика по кнопке генерации
        function handleGenerateClick(event) {
            // Проверяем, что форма валидна
            const form = document.getElementById('generateForm');
            if (form && form.checkValidity()) {
                // Отключаем кнопку
                setGenerateButtonLoading(true);
                
                // Показываем уведомление о начале генерации
                showToast('Начинаем генерацию контента...', 'info');
                
                // Скрываем старые результаты
                const resultsContainer = document.getElementById('resultsContainer');
                if (resultsContainer) {
                    resultsContainer.style.display = 'none';
                }
                
                // Отправляем AJAX запрос
                sendGenerateRequest();
            } else {
                // Если форма не валидна, показываем ошибку
                showToast('Пожалуйста, заполните все обязательные поля', 'warning');
                event.preventDefault();
            }
        }

        // Функция для получения CSRF токена
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                return token.value;
            }
            // Если токен не найден в форме, получаем из cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Отправка AJAX запроса для генерации
        function sendGenerateRequest() {
            const form = document.getElementById('generateForm');
            const formData = new FormData(form);
            
            // Получаем CSRF токен
            const csrfToken = getCSRFToken();
            
            // Показываем прогресс
            showProgress('Начинаем генерацию текста...');
            
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Показываем результаты
                    displayResults(data);
                    showToast('Контент успешно сгенерирован!', 'success');
                } else {
                    // Показываем ошибку
                    showToast(data.error || 'Ошибка генерации контента', 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при генерации контента', 'danger');
            })
            .finally(() => {
                // Включаем кнопку обратно
                setGenerateButtonLoading(false);
            });
        }

        // Показ прогресса генерации
        function showProgress(message) {
            showToast(message, 'info');
        }

        // Отображение результатов
        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultText = document.getElementById('result');
            const imageContainer = document.getElementById('imageContainer');
            const charCount = document.getElementById('charCount');
            const wordCount = document.getElementById('wordCount');
            const imageCount = document.getElementById('imageCount');
            
            if (resultsContainer && resultText) {
                // Показываем контейнер результатов
                resultsContainer.style.display = 'block';
                
                // Обновляем текст
                resultText.textContent = data.result || '';
                
                // Обновляем статистику
                if (charCount) charCount.textContent = (data.result || '').length;
                if (wordCount) wordCount.textContent = (data.result || '').split(' ').length;
                if (imageCount) imageCount.textContent = data.image_url ? '1' : '0';
                
                // Обновляем изображение
                if (data.image_url && imageContainer) {
                    // Показываем состояние загрузки
                    imageContainer.innerHTML = `
                        <div class="image-loading">
                            <i class="bi bi-image"></i>
                            <p>Загружаем изображение...</p>
                        </div>
                    `;
                    
                    // Создаем изображение для предзагрузки
                    const img = new Image();
                    img.onload = function() {
                        imageContainer.innerHTML = `
                            <div class="image-container position-relative">
                                <img src="${data.image_url}" alt="AI generated image" 
                                     class="generated-image" 
                                     onclick="openModal(this.src)" 
                                     onerror="handleImageError(this)" 
                                     onload="handleImageLoad(this)" />
                                
                                <!-- Overlay для увеличения -->
                                <div class="image-overlay" onclick="openModal('${data.image_url}')">
                                    <i class="bi bi-zoom-in text-white fs-1"></i>
                                </div>
                            </div>
                            
                            <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                                <button onclick="openModal('${data.image_url}')" class="btn btn-outline-info">
                                    <i class="bi bi-zoom-in me-2"></i>Увеличить
                                </button>
                                <button onclick="downloadImage('${data.image_url}')" class="btn btn-outline-success">
                                    <i class="bi bi-download me-2"></i>Сохранить
                                </button>
                                <button onclick="handleRegenerateImageClick(event)" class="btn btn-outline-warning">
                                    <i class="bi bi-image me-2"></i>Перегенерировать изображение
                                </button>
                            </div>
                        `;
                    };
                    img.onerror = function() {
                        imageContainer.innerHTML = `
                            <div class="image-error">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>Ошибка загрузки изображения</p>
                            </div>
                        `;
                    };
                    img.src = data.image_url;
                } else if (imageContainer) {
                    // Если изображение не сгенерировано
                    imageContainer.innerHTML = `
                        <div class="image-error">
                            <i class="bi bi-image"></i>
                            <p>Изображение не было сгенерировано</p>
                        </div>
                    `;
                }
                
                // Подстраиваем высоту текстового поля
                autoResizeTextarea();
                
                // Плавная анимация появления
                resultsContainer.style.opacity = '0';
                resultsContainer.style.transform = 'translateY(20px)';
                resultsContainer.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    resultsContainer.style.opacity = '1';
                    resultsContainer.style.transform = 'translateY(0)';
                }, 100);
            }
        }

        // Обработчик клика по кнопке "Сгенерировать ещё"
        function handleRegenerateClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2 icon-loading"></i>Генерация...';
            
            // Показываем уведомление
            showToast('Генерируем новый контент...', 'info');
            
            // Отправляем AJAX запрос
            sendGenerateRequest();
        }

        // Обработчик клика по кнопке "Перегенерировать текст"
        function handleRegenerateTextClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2 icon-loading"></i>Генерация текста...';
            
            // Показываем уведомление
            showToast('Перегенерируем текст...', 'info');
            
            // Получаем данные формы
            const formData = new FormData();
            formData.append('platform', document.getElementById('id_platform').value);
            formData.append('template_type', document.getElementById('id_template_type').value);
            formData.append('tone', document.getElementById('id_tone').value);
            formData.append('topic', document.getElementById('id_topic').value);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Отправляем AJAX запрос для перегенерации текста
            fetch('/regenerate-text/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем текст
                    const resultElement = document.getElementById('result');
                    if (resultElement) {
                        resultElement.textContent = data.result;
                        autoResizeTextarea();
                    }
                    
                    // Обновляем статистику
                    const charCount = document.getElementById('charCount');
                    const wordCount = document.getElementById('wordCount');
                    if (charCount) charCount.textContent = data.result.length;
                    if (wordCount) wordCount.textContent = data.result.split(' ').length;
                    
                    showToast('Текст успешно перегенерирован!', 'success');
                } else {
                    showToast('Ошибка при перегенерации текста: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка при перегенерации текста:', error);
                showToast('Ошибка при перегенерации текста', 'danger');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                regenerateBtn.classList.remove('btn-loading');
                regenerateBtn.disabled = false;
                regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Перегенерировать текст';
            });
        }

        // Обработчик клика по кнопке "Перегенерировать изображение"
        function handleRegenerateImageClick(event) {
            // Отключаем кнопку
            const regenerateBtn = event.target;
            regenerateBtn.classList.add('btn-loading');
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = '<i class="bi bi-image me-2 icon-loading"></i>Генерация изображения...';
            
            // Показываем уведомление
            showToast('Перегенерируем изображение...', 'info');
            
            // Получаем тему из формы
            const topic = document.getElementById('id_topic').value;
            
            // Получаем данные формы
            const formData = new FormData();
            formData.append('topic', topic);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Отправляем AJAX запрос для перегенерации изображения
            fetch('/regenerate-image/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем изображение
                    const imageContainer = document.getElementById('imageContainer');
                    if (imageContainer && data.image_url) {
                        // Показываем состояние загрузки
                        imageContainer.innerHTML = `
                            <div class="image-loading">
                                <i class="bi bi-image"></i>
                                <p>Загружаем новое изображение...</p>
                            </div>
                        `;
                        
                        // Создаем изображение для предзагрузки
                        const img = new Image();
                        img.onload = function() {
                            imageContainer.innerHTML = `
                                <div class="image-container position-relative">
                                    <img src="${data.image_url}" alt="AI generated image" 
                                         class="generated-image" 
                                         onclick="openModal(this.src)" 
                                         onerror="handleImageError(this)" 
                                         onload="handleImageLoad(this)" />
                                    
                                    <!-- Overlay для увеличения -->
                                    <div class="image-overlay" onclick="openModal('${data.image_url}')">
                                        <i class="bi bi-zoom-in text-white fs-1"></i>
                                    </div>
                                </div>
                                
                                <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                                    <button onclick="openModal('${data.image_url}')" class="btn btn-outline-info">
                                        <i class="bi bi-zoom-in me-2"></i>Увеличить
                                    </button>
                                    <button onclick="downloadImage('${data.image_url}')" class="btn btn-outline-success">
                                        <i class="bi bi-download me-2"></i>Сохранить
                                    </button>
                                    <button onclick="handleRegenerateImageClick(event)" class="btn btn-outline-warning">
                                        <i class="bi bi-image me-2"></i>Перегенерировать изображение
                                    </button>
                                </div>
                            `;
                        };
                        img.onerror = function() {
                            imageContainer.innerHTML = `
                                <div class="image-error">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <p>Ошибка загрузки изображения</p>
                                </div>
                            `;
                        };
                        img.src = data.image_url;
                    }
                    
                    // Обновляем статистику
                    const imageCount = document.getElementById('imageCount');
                    if (imageCount) imageCount.textContent = '1';
                    
                    showToast('Изображение успешно перегенерировано!', 'success');
                } else {
                    showToast('Ошибка при перегенерации изображения: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            })
            .catch(error => {
                console.error('Ошибка при перегенерации изображения:', error);
                showToast('Ошибка при перегенерации изображения', 'danger');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                regenerateBtn.classList.remove('btn-loading');
                regenerateBtn.disabled = false;
                regenerateBtn.innerHTML = '<i class="bi bi-image me-2"></i>Перегенерировать изображение';
            });
        }

        // Автоматическое подстраивание высоты текстового поля
        function autoResizeTextarea() {
            const textarea = document.getElementById('result');
            if (textarea) {
                // Создаем временный элемент для измерения высоты
                const temp = document.createElement('div');
                temp.style.cssText = `
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                    width: ${textarea.offsetWidth}px;
                    padding: ${getComputedStyle(textarea).padding};
                    font: ${getComputedStyle(textarea).font};
                    line-height: ${getComputedStyle(textarea).lineHeight};
                    word-wrap: break-word;
                    white-space: pre-wrap;
                    overflow: hidden;
                `;
                temp.textContent = textarea.textContent || textarea.innerText;
                
                document.body.appendChild(temp);
                const height = temp.scrollHeight;
                document.body.removeChild(temp);
                
                // Устанавливаем высоту с учетом минимальной и максимальной
                const minHeight = 150;
                const maxHeight = 600;
                const newHeight = Math.max(minHeight, Math.min(maxHeight, height));
                
                textarea.style.height = newHeight + 'px';
            }
        }

        // Инициализация при загрузке страницы - используем window.onload
        window.onload = function() {
            // Загружаем тему
            loadTheme();
            // Находим кнопку
            const themeToggle = document.getElementById('themeToggle');
            if (!themeToggle) {
                console.error('Кнопка не найдена!');
            }
            // Принудительно обновляем дату и время сразу
            updateDateTime();
            // Запускаем обновление даты и времени
            startDateTimeUpdate();
            // Подстраиваем высоту текстового поля
            autoResizeTextarea();
        };

        // Копирование текста
        function copyText() {
            const text = document.getElementById("result");
            navigator.clipboard.writeText(text.textContent || text.innerText).then(() => {
                showToast('Текст скопирован в буфер обмена!', 'success');
            });
        }

        // Открытие модального окна
        function openModal(imageSrc) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modalImage').src = imageSrc;
            modal.show();
        }

        // Скачивание изображения
        function downloadImage(imageSrc) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = 'ghostwriter_generated_image.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Изображение сохранено!', 'success');
        }

        // Обработка ошибок изображения
        function handleImageError(image) {
            
            // Находим контейнер изображения
            const imageContainer = image.closest('.image-container');
            if (imageContainer) {
                const parentContainer = imageContainer.parentElement;
                parentContainer.innerHTML = `
                    <div class="image-error">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Ошибка загрузки изображения</p>
                    </div>
                `;
            }
        }

        function handleImageLoad(image) {
            
            // Добавляем анимацию появления
            image.style.opacity = '0';
            image.style.transform = 'scale(0.9)';
            image.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                image.style.opacity = '1';
                image.style.transform = 'scale(1)';
            }, 100);
        }

        // Показ уведомлений
        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }

        // Функция для отображения даты и времени
        function updateDateTime() {
            const now = new Date();
            
            // Форматирование даты на русском языке
            const dateOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            
            // Форматирование времени
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            
            const currentDate = now.toLocaleDateString('ru-RU', dateOptions);
            const currentTime = now.toLocaleTimeString('ru-RU', timeOptions);
            
            // Обновляем элементы на странице
            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');
            
            if (dateElement) {
                dateElement.textContent = currentDate;
                dateElement.style.display = 'inline';
                dateElement.style.visibility = 'visible';
                dateElement.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    dateElement.style.color = '#ffffff';
                    dateElement.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                } else {
                    dateElement.style.color = 'var(--text-primary)';
                    dateElement.style.textShadow = 'none';
                }
            } else {
                console.error('Элемент даты не найден!');
            }
            
            if (timeElement) {
                timeElement.textContent = currentTime;
                timeElement.style.display = 'inline';
                timeElement.style.visibility = 'visible';
                timeElement.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    timeElement.style.color = '#ffffff';
                    timeElement.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                } else {
                    timeElement.style.color = 'var(--text-primary)';
                    timeElement.style.textShadow = 'none';
                }
            } else {
                console.error('Элемент времени не найден!');
            }
            
            // Принудительно показываем контейнеры datetime-display
            const datetimeDisplays = document.querySelectorAll('.datetime-display');
            const currentTheme = document.documentElement.getAttribute('data-theme');
            
            datetimeDisplays.forEach(display => {
                display.style.display = 'flex';
                display.style.visibility = 'visible';
                display.style.opacity = '1';
                
                // Принудительно обновляем стили для видимости
                if (currentTheme === 'light') {
                    display.style.color = '#ffffff';
                    display.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    
                    // Обновляем стили для иконок
                    const icons = display.querySelectorAll('i');
                    icons.forEach(icon => {
                        icon.style.color = '#ffffff';
                        icon.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                    });
                } else {
                    display.style.color = 'var(--text-primary)';
                    display.style.textShadow = 'none';
                    
                    // Обновляем стили для иконок
                    const icons = display.querySelectorAll('i');
                    icons.forEach(icon => {
                        icon.style.color = 'var(--text-primary)';
                        icon.style.textShadow = 'none';
                    });
                }
            });
        }
        
        // Обновляем время каждую секунду
        function startDateTimeUpdate() {
            updateDateTime(); // Первоначальное обновление
            setInterval(updateDateTime, 1000); // Обновление каждую секунду
        }
        
        // Альтернативная инициализация при готовности DOM
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
        });
        
        // Валидация формы
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/imask@7.6.0/dist/imask.js"></script>
    {% load static %}
    <script src="{% static 'subscription_tracking.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>

