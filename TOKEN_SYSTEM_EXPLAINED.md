# ๐ ะะฐะบ ัะธััะตะผะฐ ะพะฟัะตะดะตะปัะตั ะฒัะตะผะตะฝะฝัะต ัะพะบะตะฝั

## ะะฑะทะพั

**ะะะะะ:** ะะฑััะฝะฐั Django ะฐััะตะฝัะธัะธะบะฐัะธั (ัะตะณะธัััะฐัะธั/ะปะพะณะธะฝ) **ะพัะบะปััะตะฝะฐ**.

ะกะธััะตะผะฐ Ghostwriter ะธัะฟะพะปัะทัะตั **ัะพะปัะบะพ ะฒัะตะผะตะฝะฝัะต ัะพะบะตะฝั** ะดะปั ะดะพัััะฟะฐ:
- **ะัะตะผะตะฝะฝัะต ัะพะบะตะฝั** - ัะตัะตะท ัะธััะตะผั `TemporaryAccessToken` (ะฑะตะท ัะตะณะธัััะฐัะธะธ)
- ะะดะธะฝััะฒะตะฝะฝัะน ัะฟะพัะพะฑ ะฒัะพะดะฐ - ัะตัะตะท ัะพะบะตะฝ-ัััะปะบั `/auth/token/<uuid>/`

## ะัะธะพัะธัะตั ะฟัะพะฒะตัะบะธ

ะกะธััะตะผะฐ ะฟัะพะฒะตััะตั ะดะพัััะฟ ะฒ ัะปะตะดัััะตะผ ะฟะพััะดะบะต:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั                    โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. ะัะพะฒะตัะบะฐ ะธัะบะปััะตะฝะฝัั URL            โ
โ     (admin, static, media, auth/token)   โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะฝะพะณะพ ัะพะบะตะฝะฐ          โ
โ     request.session.get('access_token') โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
               โ
        โโโโโโโโดโโโโโโโ
        โ             โ
       ะะกะขะฌ          ะะะข
        โ             โ
        โผ             โผ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ ะัะพะฒะตัะธัั    โ  โ ะะตะดะธัะตะบั ะฝะฐ  โ
โ ะฒะฐะปะธะดะฝะพััั   โ  โ token_requiredโ
โ ัะพะบะตะฝะฐ       โ  โ              โ
โโโโโโโโฌโโโโโโโโ  โโโโโโโโโโโโโโโโ
       โ
โโโโโโโโดโโโโโโโ
โ             โ
ะะะะะะะ    ะะะะะะะะะ
โ             โ
โผ             โผ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ ะัะพะฟัััะธัั   โ  โ ะะตะดะธัะตะบั ะฝะฐ  โ
โ (ั ะปะธะผะธัะฐะผะธ) โ  โ invalid_tokenโ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
```

**ะัะธะผะตัะฐะฝะธะต:** ะะฑััะฝะฐั Django ะฐััะตะฝัะธัะธะบะฐัะธั ะพัะบะปััะตะฝะฐ, ะฟะพััะพะผั ะฟัะพะฒะตััะตััั ัะพะปัะบะพ ัะพะบะตะฝ.

## ะะฐะบ ัะธััะตะผะฐ ะพะฟัะตะดะตะปัะตั ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ

### 1. Middleware ะฟัะพะฒะตัะบะฐ (`TokenAccessMiddleware`)

**ะคะฐะนะป:** `generator/middleware.py`

```python
def __call__(self, request):
    # ะจะะ 1: ะัะพะฟััะบะฐะตะผ ะธัะบะปััะตะฝะฝัะต URL
    if self._is_exempt_url(request.path):
        return self.get_response(request)
    
    # ะจะะ 2: ะัะพะฒะตััะตะผ ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ ะฒ ัะตััะธะธ
    # ะะะะะะงะะะะ: ะะฑััะฝะฐั Django ะฐััะตะฝัะธัะธะบะฐัะธั ะพัะบะปััะตะฝะฐ
    token_str = request.session.get('access_token')
    
    if not token_str:
        # ะะตั ัะพะบะตะฝะฐ - ััะตะฑัะตะผ ะตะณะพ
        return redirect('token_required_page')
    
    # ะจะะ 4: ะัะพะฒะตััะตะผ ะฒะฐะปะธะดะฝะพััั ัะพะบะตะฝะฐ ะฒ ะะ
    token = TemporaryAccessToken.objects.get(
        token=token_str,
        is_active=True
    )
    
    # ะจะะ 5: ะัะพะฒะตััะตะผ ััะพะบ ะดะตะนััะฒะธั
    if token.is_expired():
        # ะขะพะบะตะฝ ะธััะตะบ - ะดะตะฐะบัะธะฒะธััะตะผ
        token.is_active = False
        token.save()
        return redirect('invalid_token_page')
    
    # ะจะะ 6: ะะปั DEMO ัะพะบะตะฝะพะฒ ะฟัะพะฒะตััะตะผ ะปะธะผะธัั
    if token.token_type == 'DEMO':
        token.reset_daily_limit()
        if token.daily_generations_left <= 0:
            return redirect('limit_exceeded_page')
    
    # ะัั ะะ - ะฟัะพะฟััะบะฐะตะผ ะทะฐะฟัะพั
    return self.get_response(request)
```

### 2. ะกะตััะธะพะฝะฝัะต ะดะฐะฝะฝัะต

ะะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒัะพะดะธั ะฟะพ ัะพะบะตะฝั (`/auth/token/<uuid>/`), ะฒ ัะตััะธั ัะพััะฐะฝััััั:

```python
request.session['access_token'] = str(token)  # UUID ัะพะบะตะฝะฐ
request.session['token_type'] = 'DEMO'        # ะขะธะฟ ัะพะบะตะฝะฐ
request.session['is_demo'] = True             # ะคะปะฐะณ DEMO
request.session['daily_generations_left'] = 5 # ะััะฐัะพะบ ะณะตะฝะตัะฐัะธะน
request.session['expires_at'] = '2026-01-17T12:00:00'  # ะะฐัะฐ ะธััะตัะตะฝะธั
```

### 3. ะะพะดะตะปั ัะพะบะตะฝะฐ (`TemporaryAccessToken`)

**ะคะฐะนะป:** `generator/models.py`

ะขะพะบะตะฝ ะธะผะตะตั ัะปะตะดัััะธะต ะฟะพะปั ะดะปั ะพะฟัะตะดะตะปะตะฝะธั ะฒัะตะผะตะฝะฝะพััะธ:

```python
class TemporaryAccessToken(models.Model):
    token = models.UUIDField()              # ะฃะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั
    token_type = models.CharField()         # DEMO, MONTHLY, YEARLY, DEVELOPER
    expires_at = models.DateTimeField()     # ะะฐัะฐ ะธััะตัะตะฝะธั
    is_active = models.BooleanField()       # ะะบัะธะฒะตะฝ ะปะธ ัะพะบะตะฝ
    daily_generations_left = models.IntegerField()  # ะะธะผะธั ะดะปั DEMO
```

**ะะตัะพะดั ะฟัะพะฒะตัะบะธ:**

```python
def is_expired(self):
    """ะัะพะฒะตััะตั, ะธััะตะบ ะปะธ ััะพะบ ะดะตะนััะฒะธั"""
    if self.token_type == 'DEVELOPER':
        return False  # DEVELOPER ัะพะบะตะฝั ะฝะต ะธััะตะบะฐัั
    return timezone.now() > self.expires_at

def can_generate(self):
    """ะัะพะฒะตััะตั, ะผะพะถะตั ะปะธ ัะพะบะตะฝ ะธัะฟะพะปัะทะพะฒะฐัััั ะดะปั ะณะตะฝะตัะฐัะธะธ"""
    if not self.is_active or self.is_expired():
        return False
    if self.token_type == 'DEMO':
        return self.daily_generations_left > 0
    return True
```

## ะฃัะธะปะธัั ะดะปั ะฟัะพะฒะตัะบะธ ัะธะฟะฐ ะดะพัััะฟะฐ

**ะคะฐะนะป:** `generator/utils.py`

### `is_temporary_token_access(request)`

ะัะพะฒะตััะตั, ะธัะฟะพะปัะทัะตั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ:

```python
from generator.utils import is_temporary_token_access

if is_temporary_token_access(request):
    # ะะพะปัะทะพะฒะฐัะตะปั ะธัะฟะพะปัะทัะตั ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ
    print("ะัะตะผะตะฝะฝัะน ะดะพัััะฟ")
else:
    # ะะฑััะฝัะน ะทะฐะปะพะณะธะฝะตะฝะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
    print("ะะฑััะฝะฐั ะฐััะตะฝัะธัะธะบะฐัะธั")
```

### `get_token_from_request(request)`

ะะพะปััะฐะตั ะพะฑัะตะบั ัะพะบะตะฝะฐ ะธะท ะทะฐะฟัะพัะฐ:

```python
from generator.utils import get_token_from_request

token = get_token_from_request(request)
if token:
    print(f"ะขะธะฟ ัะพะบะตะฝะฐ: {token.token_type}")
    print(f"ะััะตะบะฐะตั: {token.expires_at}")
```

### `get_access_type(request)`

ะะฟัะตะดะตะปัะตั ัะธะฟ ะดะพัััะฟะฐ:

```python
from generator.utils import get_access_type

access_type = get_access_type(request)
# ะะพะทะฒัะฐัะฐะตั: 'authenticated', 'demo', 'monthly', 'yearly', 'developer', ะธะปะธ 'anonymous'
```

### `is_demo_token(request)`

ะัะพะฒะตััะตั, ะธัะฟะพะปัะทัะตััั ะปะธ DEMO ัะพะบะตะฝ:

```python
from generator.utils import is_demo_token

if is_demo_token(request):
    print("ะัะฟะพะปัะทัะตััั DEMO ัะพะบะตะฝ ั ะปะธะผะธัะฐะผะธ")
```

## ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ views

### ะัะธะผะตั 1: ะะตะฝะตัะฐัะธั ะบะพะฝัะตะฝัะฐ

```python
@consume_generation  # ะะตะบะพัะฐัะพั ะฟัะพะฒะตััะตั ัะพะบะตะฝ ะธ ะปะธะผะธัั
def generator_view(request):
    # ะะปั ะพะฑััะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
    if request.user.is_authenticated:
        user = request.user
    # ะะปั ะฒัะตะผะตะฝะฝัั ัะพะบะตะฝะพะฒ
    else:
        user = None  # ะะฝะพะฝะธะผะฝะฐั ะณะตะฝะตัะฐัะธั
    
    # ะกะพะทะดะฐะตะผ ะณะตะฝะตัะฐัะธั
    gen = Generation.objects.create(
        user=user,  # None ะดะปั ัะพะบะตะฝะพะฒ, User ะดะปั ะพะฑััะฝัั
        topic=topic,
        result=result
    )
```

### ะัะธะผะตั 2: ะัะพะฒะตัะบะฐ ัะธะฟะฐ ะดะพัััะฟะฐ

```python
from generator.utils import get_access_type, is_demo_token

def my_view(request):
    access_type = get_access_type(request)
    
    if access_type == 'authenticated':
        # ะะฑััะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
        pass
    elif access_type == 'demo':
        # DEMO ัะพะบะตะฝ ั ะปะธะผะธัะฐะผะธ
        if is_demo_token(request):
            token = get_token_from_request(request)
            print(f"ะััะฐะปะพัั ะณะตะฝะตัะฐัะธะน: {token.daily_generations_left}")
    elif access_type == 'monthly':
        # MONTHLY ัะพะบะตะฝ (ะฑะตะทะปะธะผะธั)
        pass
```

### ะัะธะผะตั 3: ะกะพััะฐะฝะตะฝะธะต ะณะตะฝะตัะฐัะธะธ

```python
from generator.utils import get_user_for_generation

def save_generation(request, topic, result):
    # ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั
    user = get_user_for_generation(request)
    # ะะปั ัะพะบะตะฝะพะฒ ะฒะตัะฝะตั None, ะดะปั ะพะฑััะฝัั - request.user
    
    Generation.objects.create(
        user=user,
        topic=topic,
        result=result
    )
```

## ะะตะบะพัะฐัะพัั

### `@consume_generation`

ะัะพะฒะตััะตั ัะพะบะตะฝ ะธ ัะผะตะฝััะฐะตั ััะตััะธะบ ะณะตะฝะตัะฐัะธะน:

```python
from generator.decorators import consume_generation

@consume_generation
def generate_content(request):
    # ะะฒัะพะผะฐัะธัะตัะบะธ:
    # 1. ะัะพะฒะตััะตั ะฝะฐะปะธัะธะต ัะพะบะตะฝะฐ
    # 2. ะัะพะฒะตััะตั ััะพะบ ะดะตะนััะฒะธั
    # 3. ะัะพะฒะตััะตั ะปะธะผะธัั (ะดะปั DEMO)
    # 4. ะฃะผะตะฝััะฐะตั ััะตััะธะบ ะณะตะฝะตัะฐัะธะน
    # 5. ะะฑะฝะพะฒะปัะตั ััะฐัะธััะธะบั
    pass
```

### `@token_required`

ะัะพะฒะตััะตั ัะพะบะตะฝ ะฑะตะท ัะผะตะฝััะตะฝะธั ััะตััะธะบะฐ:

```python
from generator.decorators import token_required

@token_required
def profile_view(request):
    # ะะพัััะฟ ะบ ะฟัะพัะธะปั (ะฝะต ัะฐััะพะดัะตั ะณะตะฝะตัะฐัะธะธ)
    token = request.token  # ะะฑัะตะบั ัะพะบะตะฝะฐ ะดะพัััะฟะตะฝ ะฒ request
    pass
```

## ะะฟัะตะดะตะปะตะฝะธะต ะฒัะตะผะตะฝะฝะพััะธ ัะพะบะตะฝะฐ

### ะะพ ะฟะพะปั `expires_at`

```python
token = TemporaryAccessToken.objects.get(token=uuid)

if token.is_expired():
    print("ะขะพะบะตะฝ ะธััะตะบ")
else:
    print(f"ะขะพะบะตะฝ ะฐะบัะธะฒะตะฝ ะดะพ {token.expires_at}")
```

### ะะพ ัะธะฟั ัะพะบะตะฝะฐ

```python
if token.token_type == 'DEMO':
    # ะัะตะผะตะฝะฝัะน ัะพะบะตะฝ (5 ะดะฝะตะน)
    print("ะัะตะผะตะฝะฝัะน DEMO ัะพะบะตะฝ")
elif token.token_type == 'DEVELOPER':
    # ะคะฐะบัะธัะตัะบะธ ะฑะตัััะพัะฝัะน (100 ะปะตั)
    print("DEVELOPER ัะพะบะตะฝ (ะฑะตัััะพัะฝัะน)")
```

### ะะพ ะฝะฐะปะธัะธั ะฒ ัะตััะธะธ

```python
# ะัะปะธ ะตััั access_token ะฒ ัะตััะธะธ - ััะพ ะฒัะตะผะตะฝะฝัะน ะดะพัััะฟ
if 'access_token' in request.session:
    print("ะัะฟะพะปัะทัะตััั ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ")
elif request.user.is_authenticated:
    print("ะะฑััะฝะฐั ะฐััะตะฝัะธัะธะบะฐัะธั")
else:
    print("ะะฝะพะฝะธะผะฝัะน ะดะพัััะฟ")
```

## ะะฒัะพะผะฐัะธัะตัะบะฐั ะดะตะฐะบัะธะฒะฐัะธั

### ะงะตัะตะท APScheduler

**ะคะฐะนะป:** `generator/scheduler.py`

```python
def cleanup_expired_tokens():
    """ะะตะฐะบัะธะฒะธััะตั ะธััะตะบัะธะต ัะพะบะตะฝั ะบะฐะถะดัะน ัะฐั"""
    expired_tokens = TemporaryAccessToken.objects.filter(
        expires_at__lt=timezone.now(),
        is_active=True
    )
    expired_tokens.update(is_active=False)
```

### ะงะตัะตะท middleware

ะัะธ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต middleware ะฟัะพะฒะตััะตั ััะพะบ ะดะตะนััะฒะธั:

```python
if token.is_expired():
    token.is_active = False
    token.save()
    return redirect('invalid_token_page')
```

## ะะตะทัะผะต

**ะกะธััะตะผะฐ ะพะฟัะตะดะตะปัะตั ะฒัะตะผะตะฝะฝัะน ัะพะบะตะฝ ะฟะพ:**

1. โ **ะััััััะฒะธั ะพะฑััะฝะพะน ะฐััะตะฝัะธัะธะบะฐัะธะธ** (`not request.user.is_authenticated`)
2. โ **ะะฐะปะธัะธั `access_token` ะฒ ัะตััะธะธ** (`request.session.get('access_token')`)
3. โ **ะกััะตััะฒะพะฒะฐะฝะธั ัะพะบะตะฝะฐ ะฒ ะะ** (`TemporaryAccessToken.objects.get(...)`)
4. โ **ะะบัะธะฒะฝะพััะธ ัะพะบะตะฝะฐ** (`token.is_active == True`)
5. โ **ะกัะพะบั ะดะตะนััะฒะธั** (`not token.is_expired()`)

**ะัะธะพัะธัะตั:**
1. ะัะบะปััะตะฝะฝัะต URL (admin, static, media, auth/token)
2. ะัะตะผะตะฝะฝัะน ัะพะบะตะฝ (ะพะฑัะทะฐัะตะปะตะฝ ะดะปั ะฒัะตั ะพััะฐะปัะฝัั)
3. ะะตะดะธัะตะบั ะฝะฐ ัััะฐะฝะธัั ััะตะฑะพะฒะฐะฝะธั ัะพะบะตะฝะฐ (ะตัะปะธ ัะพะบะตะฝะฐ ะฝะตั)

**ะะฐะถะฝะพ:** ะะฑััะฝะฐั Django ะฐััะตะฝัะธัะธะบะฐัะธั ะพัะบะปััะตะฝะฐ, ะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะธัะฟะพะปัะทััั ัะพะบะตะฝั.

---

**ะัะฟะพะปัะทัะนัะต ััะธะปะธัั ะธะท `generator/utils.py` ะดะปั ัะดะพะฑะฝะพะน ะฟัะพะฒะตัะบะธ ัะธะฟะฐ ะดะพัััะฟะฐ!**
