# Настройка техподдержки и отзывов в Telegram

Реализован **гибридный вариант**: главное меню в боте, группа поддержки, форма отзывов в боте, API в Django.

---

## 1. Что сделано в коде

### Бот (`bot.py`)
- **Главное меню** после `/start`: «Тарифы и оплата», «Мои токены», «Техподдержка», «Оставить отзыв».
- **Техподдержка** — кнопка ведёт по ссылке в группу (если в `.env` задан `TELEGRAM_SUPPORT_GROUP_URL`).
- **Оставить отзыв** — форма в боте: пользователь нажимает кнопку, пишет текст (можно с оценкой в конце, например `Отлично! 5`), отзыв сохраняется в Django.
- **В группе**: бот отвечает на ключевые слова (оплата, токен, не работает, подписка, помощь) и на команду `/support` (создаётся тикет, пользователю предлагают написать в личку боту).

### Django
- **Модели**: `SupportTicket`, `Review`, `SupportChat`.
- **API** (с заголовком `X-API-Key`, если задан `DJANGO_API_KEY`):
  - `POST /api/support/create/` — создание тикета.
  - `POST /api/reviews/create/` — создание отзыва.
  - `GET /api/support/stats/?days=30` — статистика для админов (тикеты, отзывы, чаты).
- В админке: тикеты, отзывы (с действиями «Одобрить»/«Отклонить»), чаты поддержки.

---

## 2. Что сделать в Telegram

### Шаг 1. Создать группу для поддержки и отзывов
1. В Telegram: **Создать группу** → название, например: **Ghostwriter | Техподдержка и отзывы**.
2. Тип: **Супергруппа** (если планируете много участников и нужна ссылка-приглашение).
3. Добавьте в группу **вашего бота** (по username).
4. Сделайте бота **администратором** группы (чтобы он мог писать сообщения и видеть участников).
5. Включите **разрешения**: «Публикация сообщений» (или оставьте по умолчанию).

### Шаг 2. Получить ссылку на группу
- Вариант А: **Username группы**  
  Настройки группы → «Тип» → «Публичная группа» → задать username (например `ghostwriter_support`).  
  Ссылка: `https://t.me/ghostwriter_support`.
- Вариант Б: **Пригласительная ссылка**  
  Настройки группы → «Пригласить по ссылке» → «Ссылка» → скопировать (вид типа `https://t.me/c/1234567890/1` или `https://t.me/joinchat/...`).

### Шаг 3. Настроить переменные окружения
В `.env` (или в переменных окружения сервера) добавьте:

```env
# Ссылка на группу поддержки (обязательно для кнопки «Техподдержка»)
TELEGRAM_SUPPORT_GROUP_URL=https://t.me/ghostwriter_support

# Опционально: канал для публикации одобренных отзывов
# TELEGRAM_REVIEWS_GROUP_URL=https://t.me/your_reviews_channel

# ID админов (через запятую) — для будущих уведомлений о тикетах
# TELEGRAM_ADMIN_IDS=123456789
```

Как узнать свой Telegram ID: напишите боту @userinfobot в Telegram — он пришлёт ваш ID.

### Шаг 4. Применить миграции Django
```bash
python manage.py migrate
# или
py -3 manage.py migrate
```

### Шаг 5. Запуск бота
- **Локально (polling)**:  
  `python bot.py` или `py -3 bot.py`  
  Все новые обработчики (меню, отзывы, группа) работают в этом режиме.
- **Production (webhook)**:  
  Сейчас в Django в `telegram_webhook` реализована упрощённая логика (демо-токен и т.д.). Чтобы в production работало то же меню, отзывы и группа, нужно либо перевести приём обновлений на тот же код, что и в `bot.py` (общая функция построения `Application` и вызов `process_update` из webhook), либо временно использовать polling на сервере (например, через systemd/screen).

---

## 3. Поведение по пунктам

| Действие | Где | Результат |
|---------|-----|-----------|
| Кнопка «Техподдержка» | Бот | Переход по ссылке в группу (если задан `TELEGRAM_SUPPORT_GROUP_URL`). |
| Кнопка «Оставить отзыв» | Бот | Запрос текста отзыва → сохранение в БД (модерация в админке). |
| Сообщение в группе с словом «оплата», «токен» и т.д. | Группа | Автоответ бота с краткой подсказкой. |
| Команда `/support` в группе | Группа | Создаётся тикет в Django, пользователю предлагают написать в личку боту. |

---

## 4. Статистика для админов
- В Django Admin: разделы **Тикеты поддержки**, **Отзывы**, **Чаты поддержки**.
- По API:  
  `GET /api/support/stats/?days=30`  
  с заголовком `X-API-Key: <DJANGO_API_KEY>` (если ключ задан в настройках).

Ответ содержит: количество тикетов за период, по статусам, количество отзывов и ожидающих модерации, количество открытых чатов поддержки.

---

## 5. Если кнопка «Техподдержка» не ведёт в группу
Убедитесь, что в `.env` задана переменная:
`TELEGRAM_SUPPORT_GROUP_URL=https://t.me/your_group_username`  
(или ваша пригласительная ссылка).  
После изменения перезапустите бота.
